<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Form Pemesanan</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f0f0f0;
    }
    button, a {
      -webkit-tap-highlight-color: transparent;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      position: relative;
    }
    h2 { margin-top: 0; }
    .input-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    .input-group label {
      margin-bottom: 6px;
    }
    .input-group input {
      padding: 8px;
    }
    .error-msg {
      color: red;
      font-size: 12px;
      margin-top: 4px;
    }
    .pesanan-container {
      overflow-x: auto;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 70px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
      font-size: 14px;
    }
    th:nth-child(1), td:nth-child(1) { width: 30px; }
    th:nth-child(2), td:nth-child(2) { width: 100px; }
    th:nth-child(3), td:nth-child(3) { width: 60px; }
    th:nth-child(4), td:nth-child(4) { width: 60px; }
    th:nth-child(5), td:nth-child(5) { width: 80px; }
    th:nth-child(6), td:nth-child(6) { width: 40px; }
    select, input[type=number] {
      width: 100%;
      padding: 4px;
      font-size: 13px;
      box-sizing: border-box;
    }
    .hapus {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #007bff;
    }
    .hapus:hover {
      color: #0056b3;
    }
    .hapus-judul {
      color: rgb(0, 0, 0);
      font-weight: bold;
    }
    .tambah-btn {
      margin-top: 10px;
      padding: 8px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .lanjut-btn, .kembali-btn {
      position: absolute;
      bottom: 20px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
    }
    .lanjut-btn {
      right: 20px;
      background: green;
      color: black;
    }
    .lanjut-btn:active {
      background: #2ecc71;
    }
    .kembali-btn {
      left: 20px;
      background: red;
      color: white;
    }
    .kembali-btn:active {
      background: #ff4d4d;
    }
    .btn-hari {
      padding: 6px 12px;
      background-color: #e0e0e0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-hari:hover {
      background-color: #007bff;
      color: white;
    }
    .btn-hari.selected {
      background-color: #007bff;
      color: white;
    }
    @media (max-width: 600px) {
      th, td { font-size: 12px; padding: 4px; }
      .lanjut-btn, .kembali-btn {
        padding: 10px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Form Pemesanan</h2>

    <div class="input-group">
      <label>Nama:</label>
      <input type="text" id="nama">
    </div>

    <div class="input-group">
      <label>No WhatsApp:</label>
      <input type="text" id="wa" maxlength="15" oninput="validasiWA(this)">
      <div class="error-msg" id="waError"></div>
    </div>

    <div class="input-group">
      <label>Tanggal Sewa:</label>
      <input type="date" id="tanggal">
    </div>

    <div class="input-group">
      <label>Jumlah Hari:</label>
      <div id="pilihanHari" style="display: flex; flex-wrap: wrap; gap: 6px;">
        <script>
          for (let i = 1; i <= 9; i++) {
            document.write(`<button type="button" onclick="setHari(${i}, this)" class="btn-hari">${i}</button>`);
          }
        </script>
        <button type="button" onclick="showInputHari()" class="btn-hari">Lainnya</button>
      </div>
      <input type="number" id="hari" min="1" style="margin-top: 6px; display: none;" placeholder="Masukkan jumlah hari manual">
    </div>

    <div class="pesanan-container">
      <h3>Pesanan</h3>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Unit</th>
            <th>Harga</th>
            <th>Jumlah</th>
            <th>Total</th>
            <th class="hapus-judul">Hapus</th>
          </tr>
        </thead>
        <tbody id="pesananList"></tbody>
      </table>
      <button class="tambah-btn" onclick="tambahPesanan()">+ Tambah Pesanan</button>
    </div>

    <button class="kembali-btn" onclick="window.location.href='v93lmtar.html'">Kembali</button>
    <button class="lanjut-btn" onclick="lanjut()">Lanjut</button>
  </div>

<script>
  const hargaUnit = {
    "BF-888S": 15,
    "WLN KD-C1": 20,
    MIC: 20,
    PARAREL: 35,
    JACK: 35,
    EARPHONE: 5,
    "SETTING ADMIN": 10,
    "SETTING USER": 7,
  };

  const maxUnit = {
    "BF-888S": 10,
    "WLN KD-C1": 22,
    MIC: 5,
    PARAREL: 1,
    JACK: 1,
    EARPHONE: 15,
    "SETTING ADMIN": Infinity,
    "SETTING USER": Infinity,
  };

  let pesananList = JSON.parse(localStorage.getItem("formPemesanan"))?.pesanan || [];

  function getUsedUnits() {
    return pesananList.map(p => p.unit).filter(u => u);
  }

  function buildUnitOptions(selected = "") {
    const used = getUsedUnits();
    return Object.keys(hargaUnit).map(unit => {
      const disabled = (used.includes(unit) && unit !== selected) ? 'disabled' : '';
      const selectedAttr = (unit === selected) ? 'selected' : '';
      return `<option value="${unit}" ${disabled} ${selectedAttr}>${unit}</option>`;
    }).join("");
  }

  function tambahPesanan() {
    if (pesananList.length >= 8) return alert("Maksimal 8 pesanan.");
    pesananList.push({ unit: "", harga: 0, jumlah: 0, total: 0 });
    renderTable();
  }

  function hapusPesanan(index) {
    pesananList.splice(index, 1);
    renderTable();
  }

  function renderTable() {
    const tbody = document.getElementById("pesananList");
    tbody.innerHTML = "";
    pesananList.forEach((item, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${i + 1}</td>
        <td><select onchange="pilihUnit(this.value, ${i})"><option value="">Pilih</option>${buildUnitOptions(item.unit)}</select></td>
        <td><input type="number" value="${item.harga || ''}" disabled></td>
        <td><input type="number" min="1" value="${item.jumlah || ''}" onchange="ubahJumlah(this.value, ${i})"></td>
        <td><input type="number" value="${item.total || ''}" disabled></td>
        <td><button class="hapus" onclick="hapusPesanan(${i})">üóëÔ∏è</button></td>
      `;
      tbody.appendChild(row);
    });
  }

  function pilihUnit(unit, index) {
    if (!unit) return;
    const harga = hargaUnit[unit];
    pesananList[index].unit = unit;
    pesananList[index].harga = harga;
    pesananList[index].jumlah = 0;
    pesananList[index].total = 0;
    renderTable();
  }

  function ubahJumlah(jumlah, index) {
    const unit = pesananList[index].unit;
    jumlah = parseInt(jumlah);
    if (jumlah > maxUnit[unit]) {
      alert(`Maksimal unit untuk ${unit} adalah ${maxUnit[unit] === Infinity ? 'tidak terbatas' : maxUnit[unit]}`);
      renderTable();
      return;
    }
    const hari = parseInt(document.getElementById("hari").value || 1);
    const total = jumlah * pesananList[index].harga * hari * 1000;
    pesananList[index].jumlah = jumlah;
    pesananList[index].total = total;
    renderTable();
  }

  function setHari(val, btn) {
    const inputHari = document.getElementById("hari");
    inputHari.value = val;
    inputHari.style.display = "none";
    document.querySelectorAll('.btn-hari').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    hitungUlangTotal();
  }

  function showInputHari() {
    document.getElementById("hari").style.display = "block";
    document.getElementById("hari").focus();
    document.querySelectorAll('.btn-hari').forEach(b => b.classList.remove('selected'));
    hitungUlangTotal();
  }

  function hitungUlangTotal() {
    const hariBaru = parseInt(document.getElementById("hari").value || 1);
    pesananList = pesananList.map(item => {
      const jumlah = parseInt(item.jumlah || 0);
      const total = jumlah * item.harga * hariBaru * 1000;
      return { ...item, total };
    });
    renderTable();
  }

  document.getElementById("hari").addEventListener("input", hitungUlangTotal);

  function validasiWA(input) {
    const wa = input.value;
    const errorDiv = document.getElementById("waError");
    if (!/^[0-9]*$/.test(wa)) {
      errorDiv.textContent = "Hanya angka yang diperbolehkan.";
    } else if (!wa.startsWith("08")) {
      errorDiv.textContent = "Nomor harus diawali dengan 08.";
    } else if (wa.length < 12) {
      errorDiv.textContent = "Minimal 12 angka.";
    } else if (wa.length > 15) {
      errorDiv.textContent = "Maksimal 15 angka.";
    } else {
      errorDiv.textContent = "";
    }
  }

  function lanjut() {
    const nama = document.getElementById("nama").value.trim();
    const wa = document.getElementById("wa").value.trim();
    const tanggal = document.getElementById("tanggal").value;
    const hari = parseInt(document.getElementById("hari").value);
    const waValid = /^[0-9]{12,15}$/.test(wa) && wa.startsWith("08");

    if (!nama || !wa || !waValid || !tanggal || !hari || isNaN(hari)) {
      alert("Harap lengkapi semua data dengan benar.");
      return;
    }

    if (pesananList.length === 0 || pesananList.some(p => !p.unit || !p.jumlah)) {
      alert("Harap isi pesanan dengan lengkap.");
      return;
    }

    localStorage.setItem("formPemesanan", JSON.stringify({
      nama, wa, tanggal, hari, pesanan: pesananList
    }));
    window.location.href = "vgjx8.html";
  }

  window.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("tanggal").setAttribute("min", today);

    const data = JSON.parse(localStorage.getItem("formPemesanan"));
    if (data) {
      document.getElementById("nama").value = data.nama;
      document.getElementById("wa").value = data.wa || "";
      document.getElementById("tanggal").value = data.tanggal;
      document.getElementById("hari").value = data.hari;

      if (data.hari <= 9) {
        document.querySelectorAll(".btn-hari").forEach(btn => {
          if (btn.textContent == data.hari) {
            btn.classList.add("selected");
            document.getElementById("hari").style.display = "none";
          }
        });
      } else {
        document.getElementById("hari").style.display = "block";
      }

      hitungUlangTotal();
      renderTable();
    }
  });
</script>
</body>
</html>